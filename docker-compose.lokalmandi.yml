version: '3.8'

# ==================================================================================
# LOKAL MANDI - Docker Compose Configuration
# ==================================================================================
# This is a separate deployment for testing improvements to the Lokal Mandi platform
# Routes to: lokalmandi.lehana.in (via Traefik)
# 
# Key Changes from Production:
# - Different container names (lokalmandi-* prefix)
# - Different IP addresses (172.18.0.30-31)
# - Separate volumes to avoid conflicts
# - Same codebase, different deployment
# ==================================================================================

services:
  lokalmandi-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: lokalmandi-backend
    ports:
      - "5010:5000"  # Different host port to avoid conflicts
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - PORT=5000
      - FRONTEND_URL=https://lokalmandi.lehana.in
    volumes:
      - ./backend:/app
      - ./.env:/app/.env
      - /app/node_modules
      - lokalmandi-backend-data:/app/data
    command: npm run dev
    restart: unless-stopped
    networks:
      root_default:
        ipv4_address: 172.18.0.30
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lokalmandi-backend.rule=(Host(`lokalmandi.lehana.in`) || Host(`lokalmandi.aidhunik.com`)) && PathPrefix(`/api`)"
      - "traefik.http.routers.lokalmandi-backend.entrypoints=websecure"
      - "traefik.http.routers.lokalmandi-backend.tls=true"
      - "traefik.http.routers.lokalmandi-backend.priority=110"
      - "traefik.http.services.lokalmandi-backend.loadbalancer.server.port=5000"

  lokalmandi-frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: lokalmandi-frontend
    ports:
      - "3011:3001"  # Different host port to avoid conflicts
    environment:
      - REACT_APP_API_URL=https://lokalmandi.lehana.in/api
      - VITE_API_URL=https://lokalmandi.lehana.in/api
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - lokalmandi-backend
    restart: unless-stopped
    networks:
      root_default:
        ipv4_address: 172.18.0.31
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.lokalmandi-frontend.rule=Host(`lokalmandi.lehana.in`) || Host(`lokalmandi.aidhunik.com`)"
      - "traefik.http.routers.lokalmandi-frontend.entrypoints=websecure"
      - "traefik.http.routers.lokalmandi-frontend.tls=true"
      - "traefik.http.routers.lokalmandi-frontend.priority=100"
      - "traefik.http.services.lokalmandi-frontend.loadbalancer.server.port=3001"

networks:
  root_default:
    external: true

volumes:
  lokalmandi-backend-data:
    driver: local
