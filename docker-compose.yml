version: '3.8'

services:
  # Backend API Service
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: mandi-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-5000}:5000"
    environment:
      # Application Configuration
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=5000
      
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-sqlite:/app/data/mandi.db}
      
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET:-change-this-in-production}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      
      # API Keys
      - BHASHINI_API_KEY=${BHASHINI_API_KEY}
      - BHASHINI_API_URL=${BHASHINI_API_URL:-https://api.bhashini.gov.in}
      - ENAM_API_KEY=${ENAM_API_KEY}
      - ENAM_API_URL=${ENAM_API_URL:-https://api.enam.gov.in}
      - SARVAM_API_KEY=${SARVAM_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      
      # SMS/OTP Configuration
      - SMS_PROVIDER=${SMS_PROVIDER:-mock}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_PHONE_NUMBER=${TWILIO_PHONE_NUMBER}
      
      # Frontend URL for CORS
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:80}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:80}
      
      # Linguistic Provider
      - LINGUISTIC_PROVIDER=${LINGUISTIC_PROVIDER:-sarvam}
    
    volumes:
      # Persistent data storage
      - backend-data:/app/data
      - backend-logs:/app/logs
      - backend-uploads:/app/uploads
      # Shared data configuration
      - ./data:/app/shared-data:ro
    
    networks:
      - mandi-network
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    depends_on:
      - db

  # Frontend Web Application
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:5000}
    container_name: mandi-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-80}:80"
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:5000}
    
    networks:
      - mandi-network
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    depends_on:
      backend:
        condition: service_healthy

  # PostgreSQL Database (Production)
  # Uncomment this service for production deployment with PostgreSQL
  db:
    image: postgres:15-alpine
    container_name: mandi-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-mandi}
      - POSTGRES_USER=${POSTGRES_USER:-mandi_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-change-this-password}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - mandi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-mandi_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Uncomment for production use
    # command: postgres -c 'max_connections=200'

# Named volumes for persistent data
volumes:
  backend-data:
    driver: local
    name: mandi-backend-data
  backend-logs:
    driver: local
    name: mandi-backend-logs
  backend-uploads:
    driver: local
    name: mandi-backend-uploads
  postgres-data:
    driver: local
    name: mandi-postgres-data

# Custom network for service communication
networks:
  mandi-network:
    driver: bridge
    name: mandi-network
